(()=>{"use strict";const e="function"==typeof atob,t="function"==typeof btoa,n="function"==typeof Buffer,o="function"==typeof TextDecoder?new TextDecoder:void 0,r="function"==typeof TextEncoder?new TextEncoder:void 0,c=Array.prototype.slice.call("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="),a=(e=>{let t={};return e.forEach(((e,n)=>t[e]=n)),t})(c),i=/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/,s=String.fromCharCode.bind(String),l="function"==typeof Uint8Array.from?Uint8Array.from.bind(Uint8Array):e=>new Uint8Array(Array.prototype.slice.call(e,0)),d=e=>e.replace(/=/g,"").replace(/[+\/]/g,(e=>"+"==e?"-":"_")),u=e=>e.replace(/[^A-Za-z0-9\+\/]/g,""),y=t?e=>btoa(e):n?e=>Buffer.from(e,"binary").toString("base64"):e=>{let t,n,o,r,a="";const i=e.length%3;for(let i=0;i<e.length;){if((n=e.charCodeAt(i++))>255||(o=e.charCodeAt(i++))>255||(r=e.charCodeAt(i++))>255)throw new TypeError("invalid character found");t=n<<16|o<<8|r,a+=c[t>>18&63]+c[t>>12&63]+c[t>>6&63]+c[63&t]}return i?a.slice(0,i-3)+"===".substring(i):a},m=n?e=>Buffer.from(e).toString("base64"):e=>{let t=[];for(let n=0,o=e.length;n<o;n+=4096)t.push(s.apply(null,e.subarray(n,n+4096)));return y(t.join(""))},h=(e,t=!1)=>t?d(m(e)):m(e),f=e=>{if(e.length<2)return(t=e.charCodeAt(0))<128?e:t<2048?s(192|t>>>6)+s(128|63&t):s(224|t>>>12&15)+s(128|t>>>6&63)+s(128|63&t);var t=65536+1024*(e.charCodeAt(0)-55296)+(e.charCodeAt(1)-56320);return s(240|t>>>18&7)+s(128|t>>>12&63)+s(128|t>>>6&63)+s(128|63&t)},p=/[\uD800-\uDBFF][\uDC00-\uDFFFF]|[^\x00-\x7F]/g,_=n?e=>Buffer.from(e,"utf8").toString("base64"):r?e=>m(r.encode(e)):e=>y(e.replace(p,f)),g=/[\xC0-\xDF][\x80-\xBF]|[\xE0-\xEF][\x80-\xBF]{2}|[\xF0-\xF7][\x80-\xBF]{3}/g,w=e=>{switch(e.length){case 4:var t=((7&e.charCodeAt(0))<<18|(63&e.charCodeAt(1))<<12|(63&e.charCodeAt(2))<<6|63&e.charCodeAt(3))-65536;return s(55296+(t>>>10))+s(56320+(1023&t));case 3:return s((15&e.charCodeAt(0))<<12|(63&e.charCodeAt(1))<<6|63&e.charCodeAt(2));default:return s((31&e.charCodeAt(0))<<6|63&e.charCodeAt(1))}},v=e?e=>atob(u(e)):n?e=>Buffer.from(e,"base64").toString("binary"):e=>{if(e=e.replace(/\s+/g,""),!i.test(e))throw new TypeError("malformed base64.");e+="==".slice(2-(3&e.length));let t,n,o,r="";for(let c=0;c<e.length;)t=a[e.charAt(c++)]<<18|a[e.charAt(c++)]<<12|(n=a[e.charAt(c++)])<<6|(o=a[e.charAt(c++)]),r+=64===n?s(t>>16&255):64===o?s(t>>16&255,t>>8&255):s(t>>16&255,t>>8&255,255&t);return r},b=n?e=>l(Buffer.from(e,"base64")):e=>l(v(e).split("").map((e=>e.charCodeAt(0)))),S=e=>b(A(e)),E=n?e=>Buffer.from(e,"base64").toString("utf8"):o?e=>o.decode(b(e)):e=>v(e).replace(g,w),A=e=>u(e.replace(/[-_]/g,(e=>"-"==e?"+":"/")));function q(e,t,n=2e3){let o;function r(){o=setTimeout((()=>t()),n)}function c(){clearTimeout(o)}e.addEventListener("mousedown",r),e.addEventListener("touchstart",r),e.addEventListener("mouseup",c),e.addEventListener("mouseleave",c),e.addEventListener("touchend",c),e.addEventListener("touchleave",c)}function x(e){let t=0;for(;e.previousElementSibling;)e=e.previousElementSibling,t++;return t}let C;!function(){const e=document.querySelector("#input"),t=document.querySelector("#button_6"),n=document.querySelector("#left"),o=document.querySelector("#upper_2"),r=function(){let e;return function(t){return e!==t&&(e=t,!0)}}();setInterval((function(){r(e.offsetWidth-e.clientWidth)&&(t.style.right=`calc(${e.offsetWidth-e.clientWidth}px + 1vmin)`)}));const c=new MutationObserver(function(e,t,n=[]){let o;return function(r){o&&clearTimeout(o),o=setTimeout(e.bind(this,...n,r),t)}}((function(){n.style.width.includes("px")&&(n.style.width=parseInt(n.style.width,10)/document.querySelector(".container").offsetWidth*100+"%"),o.style.height.includes("px")&&(o.style.height=parseInt(o.style.height,10)/document.querySelector(".right").offsetHeight*100+"%")}),75));c.observe(n,{attributes:!0}),c.observe(o,{attributes:!0}),function(){const t=document.querySelector("#button_5"),o=document.querySelector("#right");C=0,e.onfocus=()=>C=1,t.onclick=function(){o.style.display="none",n.style.display="flex",C=0},window.addEventListener("resize",(function(){window.matchMedia("(orientation: portrait)").matches&&C&&(n.style.display="none",o.style.display="flex")})),window.addEventListener("resize",(function(){window.matchMedia("(orientation: portrait)").matches&&!C&&(n.style.display="flex",o.style.display="none")}))}()}(),function(){const e=document.querySelector("#button_1"),t=document.querySelector("#button_5"),n=document.querySelector("#button_6");function o(e){let t=1;const n=function(e){t&&!e.target.classList.contains("button_active")&&(e.target.classList.add("button_active"),t=0)},o=function(e,t,n=[]){let o;return function(r){o||(e.apply(this,[...n,r]),o=setTimeout((()=>o=null),t))}}((function(e){const n=setInterval((function(){t&&e.target.classList.contains("button_active")&&(e.target.classList.remove("button_active"),t=0,clearInterval(n))}))}),300);e.addEventListener("click",(e=>e.preventDefault())),e.addEventListener("mousedown",n),e.addEventListener("touchstart",n),e.addEventListener("mouseup",o),e.addEventListener("mouseleave",o),e.addEventListener("touchend",o),e.addEventListener("touchleave",o),e.addEventListener("transitionend",(function(){t=1}))}t.addEventListener("click",(e=>e.preventDefault())),o(n),o(e)}(),function(){const e=new class{constructor(e){this.data=new Array,this.storename=e,this.#e()}#t(e,t,n){return{c_name:e,Key:t,storeornot:n,messages:new Array}}#n(e,t){return[e,t]}#o(){localStorage.setItem(this.storename,((e,t=!1)=>t?d(_(e)):_(e))(JSON.stringify(this.data.filter((e=>e.storeornot))),!0))}#e(){const e=localStorage.getItem(this.storename);e&&(this.data=JSON.parse(E(A(e))))}create(e,t,n){this.data.push(this.#t(e,t,n)),this.#o()}add_mine(e,t){this.data[e].messages.push(this.#n(t,0)),this.#o()}add_others(e,t){this.data[e].messages.push(this.#n(t,1)),this.#o()}delete_message_by_id(e,t){this.data[e].messages.splice(t,1),this.#o()}delete_chat_by_id(e){this.data.splice(e,1),this.#o()}get_Key_by_id(e){return this.data[e].Key}get_lastm_by_id(e){return this.data[e].messages[this.data[e].messages.length-1]}get_messages_by_id(e){return this.data[e].messages}}("chatdata");let t;function n(n){const o=document.querySelector("#left"),c=document.querySelector("#name_list"),a=document.querySelector("#mask"),i=document.createElement("li"),s=document.createElement("h1"),l=document.createElement("p");s.classList.add("line_1"),l.classList.add("line_2"),s.innerText=n,l.innerText="",i.appendChild(s),i.appendChild(l),i.onclick=function(){const e=x(this);e!=t&&(document.querySelectorAll("#name_list li").forEach((e=>e.classList.remove("name_active"))),this.classList.add("name_active"),a.style.display="none",document.getElementById("input").value="",r(e)),C=1,window.matchMedia("(orientation: portrait)").matches&&(document.querySelector("#right").style.display="flex",o.style.display="none"),document.querySelector("#input").focus()},q(i,(function(){confirm("是否删除本对话")&&(e.delete_chat_by_id(x(i)),t===x(i)?(document.querySelectorAll("#chat_list li").forEach((e=>e.remove())),a.style.display="block",document.querySelector("#input").value="",t=-1):t>x(i)&&t--,i.remove())})),c.appendChild(i)}function o(t){const n=document.querySelector("#name_list li:nth-child("+(t+1)+")");try{n.lastChild.innerText=e.get_lastm_by_id(t)[0]}catch{n.lastChild.innerText=""}}function r(n){const r=document.querySelector("#chat_list"),c=document.querySelector("#upper_2");function a(t){const c=document.createElement("li");c.classList.add("the_other"),c.innerText=t,q(c,(function(){confirm("是否删除本条信息")&&(e.delete_message_by_id(n,x(c)),c.remove(),o(n))})),r.appendChild(c)}function i(t){const c=document.createElement("li");c.classList.add("me"),c.innerText=t,q(c,(function(){confirm("是否删除本条信息")&&(e.delete_message_by_id(n,x(c)),c.remove(),o(n))})),r.appendChild(c)}if(t===n){const t=e.get_lastm_by_id(n);t[1]?a(t[0]):i(t[0])}else t=n,document.querySelectorAll("#chat_list li").forEach((e=>e.remove())),e.get_messages_by_id(n).forEach((function(e){e[1]?a(e[0]):i(e[0])}));c.scrollTop=c.scrollHeight-c.offsetHeight}localStorage.getItem("chatdata")?e.data.forEach(((e,t)=>{n(e.c_name),o(t)})):alert("基本使用指南：\n\n1.  点击 + 号按要求创建对话\n2.  输入信息并点击 ↑（快捷键：Ctrl+Enter）\n3.  如果输入框中没有出现密文，则说明密文已经被自动复制到了剪贴板中，可以直接粘贴给对方，相反则需要手动复制\n4.  输入对方发送来的密文并点击 ↑（快捷键：Ctrl+Enter）\n5.  若要删除某个对话或消息请长按它\n\nPs：推荐使用Chrome或Edge浏览器"),function(){const t=document.querySelector("#left"),o=document.querySelector("#button_1"),r=document.querySelector("#button_4"),c=document.querySelector("#button_3"),a=document.querySelector("#button_2"),i=document.querySelector("#storeornot"),s=document.querySelector("#chat_name"),l=document.querySelector("#other_pubkey"),d=document.querySelector("#add_new_box");let u,y=0;function m(){const e=document.getElementById("my_pubkey");(async function(e){const t=await window.crypto.subtle.generateKey({name:"ECDH",namedCurve:e},!0,["deriveKey"]),n=h(new Uint8Array(await window.crypto.subtle.exportKey("raw",t.publicKey)),!0);return[t.privateKey,n]})(i.checked?"P-256":"P-384").then((t=>{u=t[0],e.innerText=t[1]}))}s.onfocus=()=>C=0,l.onfocus=()=>C=0,c.onclick=()=>{d.style.display="none",i.checked=!1},r.onclick=function(){y<2?(document.querySelector(`#add-${y+1}`).style.display="none",y++,document.querySelector(`#add-${y+1}`).style.display="flex",2==y&&l.focus()):function(){d.style.display="none";const t=i.checked;s.value&&l.value?async function(e,t,n){const o=await window.crypto.subtle.importKey("raw",S(t),{name:"ECDH",namedCurve:n},!1,[]),r=await window.crypto.subtle.deriveKey({name:"ECDH",public:o},e,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"]);return h(new Uint8Array(await window.crypto.subtle.exportKey("raw",r)))}(u,l.value,t?"P-256":"P-384").then((o=>{var r,c,a;r=s.value,c=o,a=t,e.create(r,c,a),n(r),document.querySelector("#name_list li:last-child").click()})).catch((()=>{alert("交换密钥出错，请重试")})):alert("内容输入不全"),i.checked=!1}()},a.onclick=function(){y>0&&(document.querySelector(`#add-${y+1}`).style.display="none",document.querySelector(`#add-${y}`).style.display="flex",y--),0==y&&s.focus()},i.onchange=m,o.onclick=function(){m(),y=0,s.value="",l.value="",d.style.display="block",t.scrollTop=t.scrollHeight-t.offsetHeight,document.querySelector("#add-3").style.display="none",document.querySelector("#add-2").style.display="none",document.querySelector("#add-1").style.display="flex",C=0,s.focus()},i.onclick=function(){i.checked&&alert("此项务必和对方设定一致，否则交换密钥将出错")}}(),function(){const t=document.querySelector("#input");async function n(){const n=x(document.querySelector(".name_active"));if(t.value){try{const o=await async function(e,t){const n=await window.crypto.subtle.importKey("raw",S(e),"AES-GCM",!0,["encrypt","decrypt"]),o=S(t),r=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:o.slice(0,1),tagLength:32},n,o.slice(1));return(new TextDecoder).decode(new Uint8Array(r))}(e.get_Key_by_id(n),t.value);e.add_others(n,o),t.value=""}catch{const o=await async function(e,t){const n=await window.crypto.subtle.importKey("raw",S(e),"AES-GCM",!0,["encrypt","decrypt"]),o=window.crypto.getRandomValues(new Uint8Array(1)),r=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:o,tagLength:32},n,(new TextEncoder).encode(t)),c=new Uint8Array(r.byteLength+1);return c.set(new Uint8Array(o),0),c.set(new Uint8Array(r),1),h(c,!0)}(e.get_Key_by_id(n),t.value);e.add_mine(n,t.value),navigator.clipboard.writeText(o).then((()=>t.value="")).catch((()=>t.value=o))}r(n),o(n)}}document.querySelector("#button_6").addEventListener("click",n),t.addEventListener("keydown",(function(e){e.ctrlKey&&13==e.keyCode&&n()}))}()}()})();